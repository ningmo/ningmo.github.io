<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.9.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="Apache Rewrite 规则详解">








  <link rel="alternate" href="/default" title="追寻一颗宁静的心">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1">



<link rel="canonical" href="http://ningmo.github.io/2012/12/18/Apache Rewrite 规则详解/">


<meta name="description" content="1、Rewrite规则简介：   Rewirte主要的功能就是实现URL的跳转，它的正则表达式是基于Perl语言。可基于服务器级的(httpd.conf)和目录级的(.htaccess)两种方式。如果要想用到rewrite模块，必须先安装或加载rewrite模块。方法有两种一种是编译apache的时候就直接安装rewrite模块，别一种是编译apache时以DSO模式安装apache,然后再利用源">
<meta property="og:type" content="article">
<meta property="og:title" content="Apache Rewrite 规则详解">
<meta property="og:url" content="http://ningmo.github.io/2012/12/18/Apache Rewrite 规则详解/index.html">
<meta property="og:site_name" content="追寻一颗宁静的心">
<meta property="og:description" content="1、Rewrite规则简介：   Rewirte主要的功能就是实现URL的跳转，它的正则表达式是基于Perl语言。可基于服务器级的(httpd.conf)和目录级的(.htaccess)两种方式。如果要想用到rewrite模块，必须先安装或加载rewrite模块。方法有两种一种是编译apache的时候就直接安装rewrite模块，别一种是编译apache时以DSO模式安装apache,然后再利用源">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-08-23T09:29:47.660Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Apache Rewrite 规则详解">
<meta name="twitter:description" content="1、Rewrite规则简介：   Rewirte主要的功能就是实现URL的跳转，它的正则表达式是基于Perl语言。可基于服务器级的(httpd.conf)和目录级的(.htaccess)两种方式。如果要想用到rewrite模块，必须先安装或加载rewrite模块。方法有两种一种是编译apache的时候就直接安装rewrite模块，别一种是编译apache时以DSO模式安装apache,然后再利用源">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Apache Rewrite 规则详解 - 追寻一颗宁静的心 </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">追寻一颗宁静的心</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Apache Rewrite 规则详解
        
      </h1>

      <time class="post-time">
          Dec 18 2012
      </time>
    </header>



    
            <div class="post-content">
            <p><strong>1、Rewrite规则简介：</strong></p>
<p><strong> </strong></p>
<p>Rewirte主要的功能就是实现URL的跳转，它的正则表达式是基于Perl语言。可基于服务器级的(httpd.conf)和目录级的(.htaccess)两种方式。如果要想用到rewrite模块，必须先安装或加载rewrite模块。方法有两种一种是编译apache的时候就直接安装rewrite模块，别一种是编译apache时以DSO模式安装apache,然后再利用源码和apxs来安装rewrite模块。</p>
<p>基于服务器级的(httpd.conf)有两种方法，一种是在httpd.conf的全局下直接利用RewriteEngine on来打开rewrite功能;另一种是在局部里利用RewriteEngine on来打开rewrite功能,下面将会举例说明，需要注意的是,必须在每个virtualhost里用RewriteEngine on来打开rewrite功能。否则virtualhost里没有RewriteEngine on它里面的规则也不会生效。</p>
<p>基于目录级的(.htaccess),要注意一点那就是必须打开此目录的FollowSymLinks属性且在.htaccess里要声明RewriteEngine on。</p>
<p>&nbsp;</p>
<p><strong>2、举例说明：</strong></p>
<p>例一.下面是在一个虚拟主机里定义的规则。功能是把client请求的主机前缀不是<a href="http://www.kiya.cn和70.40.213.183都跳转到主机前缀为http://www.kiya.cn，避免相同内容的网页有多个指向的域名，如http://kiya.cn。" target="_blank" rel="noopener">www.kiya.cn和70.40.213.183都跳转到主机前缀为http://www.kiya.cn，避免相同内容的网页有多个指向的域名，如http://kiya.cn。</a></p>
<p>NameVirtualHost 70.40.213.183:80<br>ServerAdmin <a href="mailto:slj@kiya.cn" target="_blank" rel="noopener">slj@kiya.cn</a><br>DocumentRoot “/web”<br>ServerName kiya.cn</p>
<p>RewriteEngine on #打开rewirte功能<br>RewriteCond %{HTTP_HOST} !^<a href="http://www.kiya.cn" target="_blank" rel="noopener">www.kiya.cn</a> [NC] #声明Client请求的主机中前缀不是<a href="http://www.kiya.cn，其中" target="_blank" rel="noopener">www.kiya.cn，其中</a> [NC] 的意思是忽略大小写<br>RewriteCond %{HTTP_HOST} !^70.40.213.183 [NC] #声明Client请求的主机中前缀不是70.40.213.183，其中 [NC] 的意思是忽略大小写<br>RewriteCond %{HTTP_HOST} !^$ #声明Client请求的主机中前缀不为空<br>RewriteRule ^(.<em>) <a href="http://www.kiya.cn/" target="_blank" rel="noopener">http://www.kiya.cn/</a> [L] #含义是如果Client请求的主机中的前缀符合上述条件，则直接进行跳转到<a href="http://www.kiya.cn/,[L]意味着立即停止重写操作，并不再应用其他重写规则。这里的.*是指匹配所有URL中不包含换行字符，()括号的功能是把所有的字符做一个标记，以便于后面的应用.就是引用前面里的" target="_blank" rel="noopener">http://www.kiya.cn/,[L]意味着立即停止重写操作，并不再应用其他重写规则。这里的.*是指匹配所有URL中不包含换行字符，()括号的功能是把所有的字符做一个标记，以便于后面的应用.就是引用前面里的</a>(.</em>)字符。</p>
<p>例二.将输入 en.sicasoft.com 的域名时跳转到<a href="http://www.sicasoft.com" target="_blank" rel="noopener">www.sicasoft.com</a></p>
<p>RewriteEngine on<br>RewriteCond %{HTTP_HOST} ^en.sicasoft.com [NC]<br>RewriteRule ^(.*) <a href="http://www.sicasoft.com/" target="_blank" rel="noopener">http://www.sicasoft.com/</a> [L]</p>
<p>例三.赛卡软件近期更换了域名，新域名为<a href="http://www.sicasoft.com" target="_blank" rel="noopener">www.sicasoft.com</a>, 更加简短好记。这时需要将原来的域名ss.kiya.cn, 以及论坛所在地址ss.kiya.cn/bbs/定向到新的域名，以便用户可以找到，并且使原来的论坛 URL 继续有效而不出现 404 未找到，比如原来的<a href="http://ss.kiya.cn/bbs/tread-60.html" target="_blank" rel="noopener">http://ss.kiya.cn/bbs/tread-60.html</a>, 让它在新的域名下继续有效，点击后转发到<a href="http://bbs.sicasoft.com/tread-60.html，而其他网页，如原先的http://ss.kiya.cn/purchase不会到二级域名bbs.sicasoft.com/purchase上，而是到www.sicasoft.com/purchase" target="_blank" rel="noopener">http://bbs.sicasoft.com/tread-60.html，而其他网页，如原先的http://ss.kiya.cn/purchase不会到二级域名bbs.sicasoft.com/purchase上，而是到www.sicasoft.com/purchase</a><br>按照这样的要求重定向规则应该这样写：</p>
<p>RewriteEngine On<br>RewriteCond %{REQUEST_URI} ^/bbs/<br>RewriteRule ^bbs/(.<em>) <a href="http://bbs.sicasoft.com/$1" target="_blank" rel="noopener">http://bbs.sicasoft.com/$1</a> [R=permanent,L]<br>RewriteCond %{REQUEST_URI} !^/bbs/<br>RewriteRule ^(.</em>) <a href="http://www.sicasoft.com/$1" target="_blank" rel="noopener">http://www.sicasoft.com/$1</a> [R=permanent,L]</p>
<p>&nbsp;</p>
<p><strong>3.Apache mod_rewrite规则重写的标志一览</strong></p>
<p><strong> </strong></p>
<p>1) R[=code](force redirect) 强制外部重定向<br>强制在替代字符串加上<a href="http://thishost[:thisport]/前缀重定向到外部的URL.如果code不指定，将用缺省的302" target="_blank" rel="noopener">http://thishost[:thisport]/前缀重定向到外部的URL.如果code不指定，将用缺省的302</a> HTTP状态码。<br>2) F(force URL to be forbidden)禁用URL,返回403HTTP状态码。<br>3) G(force URL to be gone) 强制URL为GONE，返回410HTTP状态码。<br>4) P(force proxy) 强制使用代理转发。<br>5) L(last rule) 表明当前规则是最后一条规则，停止分析以后规则的重写。<br>6) N(next round) 重新从第一条规则开始运行重写过程。<br>7) C(chained with next rule) 与下一条规则关联</p>
<p>如果规则匹配则正常处理，该标志无效，如果不匹配，那么下面所有关联的规则都跳过。</p>
<p>8) T=MIME-type(force MIME type) 强制MIME类型<br>9) NS (used only if no internal sub-request) 只用于不是内部子请求<br>10) NC(no case) 不区分大小写<br>11) QSA(query string append) 追加请求字符串<br>12) NE(no URI escaping of output) 不在输出转义特殊字符<br>例如：RewriteRule /foo/(.<em>) /bar?arg=P1%3d$1 [R,NE] 将能正确的将/foo/zoo转换成/bar?arg=P1=zoo<br>13) PT(pass through to next handler) 传递给下一个处理<br>例如：<br>RewriteRule ^/abc(.</em>) /def$1 [PT] # 将会交给/def规则处理<br>Alias /def /ghi<br>14) S=num(skip next rule(s)) 跳过num条规则<br>15) E=VAR:VAL(set environment variable) 设置环境变量</p>
<p>&nbsp;</p>
<p><strong>4.Apache rewrite例子集合</strong></p>
<p><strong> </strong></p>
<p>URL重定向</p>
<p>例子一:<br>同时达到下面两个要求：<br>1.用<a href="http://www.zzz.com/xxx.php" target="_blank" rel="noopener">http://www.zzz.com/xxx.php</a> 来访问 <a href="http://www.zzz.com/xxx/" target="_blank" rel="noopener">http://www.zzz.com/xxx/</a><br>2.用<a href="http://yyy.zzz.com" target="_blank" rel="noopener">http://yyy.zzz.com</a> 来访问 <a href="http://www.zzz.com/user.php?username=yyy" target="_blank" rel="noopener">http://www.zzz.com/user.php?username=yyy</a> 的功能</p>
<p>RewriteEngine On<br>RewriteCond %{HTTP_HOST} ^<a href="http://www.zzz.com" target="_blank" rel="noopener">www.zzz.com</a><br>RewriteCond %{REQUEST_URI} !^user.php$<br>RewriteCond %{REQUEST_URI} .php$<br>RewriteRule (.*).php$ <a href="http://www.zzz.com/$1/" target="_blank" rel="noopener">http://www.zzz.com/$1/</a> [R]<br>RewriteCond %{HTTP_HOST} !^<a href="http://www.zzz.com" target="_blank" rel="noopener">www.zzz.com</a><br>RewriteRule ^(.+) %{HTTP_HOST} [C]<br>RewriteRule ^([^.]+).zzz.com <a href="http://www.zzz.com/user.php?username=$1" target="_blank" rel="noopener">http://www.zzz.com/user.php?username=$1</a></p>
<p>例子二：</p>
<p>/type.php?typeid=* –&gt; /type<em>.html<br>/type.php?typeid=</em>&amp;page=* –&gt; /type<em>page</em>.html</p>
<p>RewriteRule ^/type([0-9]+).html$ /type.php?typeid=$1 [PT]<br>RewriteRule ^/type([0-9]+)page([0-9]+).html$ /type.php?typeid=$1&amp;page=$2 [PT]</p>
<p>&nbsp;</p>
<p><strong>5.使用Apache的URL Rewrite配置多用户虚拟服务器</strong></p>
<p><strong> </strong></p>
<p>要实现这个功能，首先要在DNS服务器上打开域名的泛域名解析（自己做或者找域名服务商做）。比如，我就把 *.kiya.us和 *.kiya.cn全部解析到了我的IP地址70.40.213.183上。</p>
<p>然后，看一下我的Apache中关于*.kiya.us的虚拟主机的设定。</p>
<p>ServerAdmin <a href="mailto:webmaster@kiya.us" target="_blank" rel="noopener">webmaster@kiya.us</a><br>DocumentRoot /home/www/<a href="http://www.kiya.us" target="_blank" rel="noopener">www.kiya.us</a><br>ServerName dns.kiya.us<br>ServerAlias dns.kiya.us kiya.us *.kiya.us<br>CustomLog /var/log/httpd/osa/access_log.log” common<br>ErrorLog /var/log/httpd/osa/error_log.log”<br>AllowOverride None<br>Order deny,allow</p>
<p>#AddDefaultCharset GB2312</p>
<p>RewriteEngine on<br>RewriteCond %{HTTP_HOST} ^[^.]+.kiya.(cn|us)$<br>RewriteRule ^(.+) %{HTTP_HOST}$1 [C]<br>RewriteRule ^([^.]+).kiya.(cn|us)(.*)$ /home/www/<a href="http://www.kiya.us/sylvan$3?un=$1&amp;%{QUERY_STRING}" target="_blank" rel="noopener">www.kiya.us/sylvan$3?un=$1&amp;%{QUERY_STRING}</a> [L]</p>
<p>在这段设定中，我把<em>.kiya.cn和</em>.kiya.us 的Document Root都设定到了 /home/www/<a href="http://www.kiya.us" target="_blank" rel="noopener">www.kiya.us</a></p>
<p>继续看下去，在这里我就配置了URL Rewrite规则。</p>
<p>RewriteEngine on #打开URL Rewrite功能<br>RewriteCond %{HTTP_HOST} ^[^.]+.kiya.(cn|us)$ #匹配条件，如果用户输入的URL中主机名是类似 xxxx.kiya.us 或者 xxxx.kiya.cn 就执行下面一句<br>RewriteRule ^(.+) %{HTTP_HOST}$1 [C] #把用户输入完整的地址（GET方式的参数除外）作为参数传给下一个规则，[C]是Chain串联下一个规则的意思<br>RewriteRule ^([^.]+).kiya.(cn|us)(.*)$ /home/www/dev.kiya.us/sylvan$3?un=$1&amp;%{QUERY_STRING} [L]</p>
<h1 id="最关键的是这一句，使用证则表达式解析用户输入的URL地址，把主机名中的用户名信息作为名为un的参数传给-home-www-dev-kiya-us目录下的脚本，并在后面跟上用户输入的GET方式的传入参数。并指明这是最后一条规则（-L-规则）。注意，在这一句中指明的重写后的地址用的是服务器上的绝对路径，这是内部跳转。如果使用http-xxxx这样的URL格式，则被称为外部跳转。使用外部跳转的话，浏览着的浏览器中的URL地址会改变成新的地址，而使用内部跳转则浏览器中的地址不发生改变，看上去更像实际的二级域名虚拟服务器。"><a href="#最关键的是这一句，使用证则表达式解析用户输入的URL地址，把主机名中的用户名信息作为名为un的参数传给-home-www-dev-kiya-us目录下的脚本，并在后面跟上用户输入的GET方式的传入参数。并指明这是最后一条规则（-L-规则）。注意，在这一句中指明的重写后的地址用的是服务器上的绝对路径，这是内部跳转。如果使用http-xxxx这样的URL格式，则被称为外部跳转。使用外部跳转的话，浏览着的浏览器中的URL地址会改变成新的地址，而使用内部跳转则浏览器中的地址不发生改变，看上去更像实际的二级域名虚拟服务器。" class="headerlink" title="最关键的是这一句，使用证则表达式解析用户输入的URL地址，把主机名中的用户名信息作为名为un的参数传给/home/www/dev.kiya.us目录下的脚本，并在后面跟上用户输入的GET方式的传入参数。并指明这是最后一条规则（[L]规则）。注意，在这一句中指明的重写后的地址用的是服务器上的绝对路径，这是内部跳转。如果使用http://xxxx这样的URL格式，则被称为外部跳转。使用外部跳转的话，浏览着的浏览器中的URL地址会改变成新的地址，而使用内部跳转则浏览器中的地址不发生改变，看上去更像实际的二级域名虚拟服务器。"></a>最关键的是这一句，使用证则表达式解析用户输入的URL地址，把主机名中的用户名信息作为名为un的参数传给/home/www/dev.kiya.us目录下的脚本，并在后面跟上用户输入的GET方式的传入参数。并指明这是最后一条规则（[L]规则）。注意，在这一句中指明的重写后的地址用的是服务器上的绝对路径，这是内部跳转。如果使用<a href="http://xxxx这样的URL格式，则被称为外部跳转。使用外部跳转的话，浏览着的浏览器中的URL地址会改变成新的地址，而使用内部跳转则浏览器中的地址不发生改变，看上去更像实际的二级域名虚拟服务器。" target="_blank" rel="noopener">http://xxxx这样的URL格式，则被称为外部跳转。使用外部跳转的话，浏览着的浏览器中的URL地址会改变成新的地址，而使用内部跳转则浏览器中的地址不发生改变，看上去更像实际的二级域名虚拟服务器。</a></h1><p>设置后重启Apache服务器就大功告成了！</p>
<p>&nbsp;</p>
<p>Update May 1, 2009</p>
<p>&nbsp;</p>
<p>今天上网看到了有人提一个问题：</p>
<p>求Rewrite 防盗链正则<br>不允许<a href="http://www.im286.com" target="_blank" rel="noopener">www.im286.com</a> <a href="http://www.chinaz.com" target="_blank" rel="noopener">www.chinaz.com</a> 这两个网站盗链 , 其它的网站都可以盗链的规则怎么写.</p>
<div>论坛中的答案是：</div>
RewriteEngine On
RewriteCond %{HTTP_REFERER} chinaz.com [NC]
RewriteCond %{HTTP_REFERER} im286.com [NC]
RewriteRule .*\.(jpg|jpeg|gif|png|rar|zip|txt|ace|torrent|gz|swf)$ http://www.xxx.com/fuck.png [R,NC,L]

<p>Update May 7, 2009</p>
<p>介绍一篇文章：<a href="http://lamp.linux.gov.cn/Apache/ApacheMenu/mod/mod_rewrite.html" target="_blank">http://lamp.linux.gov.cn/Apache/ApacheMenu/mod/mod_rewrite.html</a></p>
<p>Update May 24, 2009</p>
<p>&nbsp;</p>
<p>一、关于是否需要使用完全转义，比如在 RewriteCond %{HTTP_REFERER} chinaz.com [NC] 中 把 chinaz.com 改成 chinaz.com<br>答案是，两者都是可以的。</p>
<p>&nbsp;</p>
<p>二、今天在做 YOURcaddy.com （就是我去年做的PlanetCoachella的变形）的时候，在 GoDaddy 主机上无法正常转向，后来找到了问题：<br>在HostMonster以及我自己的机器上，是用<br>RewriteRule ^business/([^.]+)$ biz/detail.php?name=$1 [L]<br>达到改写的。而在Godaddy主机上，是这样：<br>RewriteRule ^business/([^.]+)$ /biz/detail.php?name=$1 [L]<br>目标文件前多了一个/<br>现在想想，可能是因为没有指定RewriteBase，至于到底是不是我改日再验证一下。</p>
<p>&nbsp;</p>
<p>三、添加两个关于判断 USER AGENT 例子和自动添加.php扩展名及自动换.html到.php扩展名的例子：<br>1</p>
<p>RewriteEngine on<br>RewriteCond %{HTTP_USER_AGENT} ^MSIE [NC,OR]<br>RewriteCond %{HTTP_USER_AGENT} ^Opera [NC]<br>RewriteRule ^.* – [F,L] 这里”-”表示没有替换，浏览器为IE和Opera的访客将被禁止访问。</p>
<p>2</p>
<p>RewriteEngine On<br>RewriteBase /test<br>RewriteCond %{REQUEST_FILENAME}.php -f<br>RewriteRule ([^/]+)$ /test/$1.php</p>
<p>#for example: /test/admin =&gt; /test/admin.php<br>RewriteRule ([^/]+).html$ /test/$1.php [L]</p>
<p>#for example: /test/admin.html =&gt; /test/admin.php</p>
<p>限制目录只能显示图片<br>&lt; IfModule mod_rewrite.c&gt;<br>RewriteEngine on<br>RewriteCond %{REQUEST_FILENAME} !^.<em>.(gif|jpg|jpeg|png|swf)$<br>RewriteRule .</em>$ – [F,L]<br>&lt; /IfModule&gt;</p>
<p>Update Jun 10, 2009</p>
<p>补充，关于特定文件扩展名的重写。</p>
<p>重写有某些扩展名的文件：<br>RewriteRule (.<em>.css$|.</em>.js$) gzip.php?$1 [L]<br>如果要排除一些扩展名：<br>RewriteRule !.(js|ico|gif|jpg|JPG|png|PNG|css|pdf|swf)$ index.php</p>

            </div>
          

    
      <footer class="post-footer">
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2012/12/18/常用的8个.htaccess代码/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">常用的8个.htaccess代码</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2012/12/18/modrewite 将URL定向到另一个目录或文件，而地址栏URL不变，网页内容为新地址内容/">
        <span class="next-text nav-default">modrewite 将URL定向到另一个目录或文件，而地址栏URL不变，网页内容为新地址内容</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2019
    <span class="footer-author">ningmo.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
