<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.9.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="url_rewrite_rule">








  <link rel="alternate" href="/public/default" title="追寻一颗宁静的心">




  <link rel="shortcut icon" type="image/x-icon" href="/public/favicon.ico?v=1.1">



<link rel="canonical" href="http://ningmo.github.io/2012/12/18/URL重写规则/">


<meta name="description" content="开启mod_rewrite开启mod_rewrite模块使用URL重写功能，需要安装mod_rewrite模块。使用phpinfo()函数，找到Apache Modules section部分，可以看到当前apache加载模块。如果没有开启mod_rewrite, 就需要配置mod_rewrite.so的路径：LoadModule rewrite_module modules/mod_rewrit">
<meta property="og:type" content="article">
<meta property="og:title" content="url_rewrite_rule">
<meta property="og:url" content="http://ningmo.github.io/2012/12/18/URL重写规则/index.html">
<meta property="og:site_name" content="追寻一颗宁静的心">
<meta property="og:description" content="开启mod_rewrite开启mod_rewrite模块使用URL重写功能，需要安装mod_rewrite模块。使用phpinfo()函数，找到Apache Modules section部分，可以看到当前apache加载模块。如果没有开启mod_rewrite, 就需要配置mod_rewrite.so的路径：LoadModule rewrite_module modules/mod_rewrit">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-08-23T09:24:57.219Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="url_rewrite_rule">
<meta name="twitter:description" content="开启mod_rewrite开启mod_rewrite模块使用URL重写功能，需要安装mod_rewrite模块。使用phpinfo()函数，找到Apache Modules section部分，可以看到当前apache加载模块。如果没有开启mod_rewrite, 就需要配置mod_rewrite.so的路径：LoadModule rewrite_module modules/mod_rewrit">


<link rel="stylesheet" type="text/css" href="/public/css/style.css?v=1.1">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> url_rewrite_rule - 追寻一颗宁静的心 </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/public/." class="logo">追寻一颗宁静的心</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/public/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/public/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          url_rewrite_rule
        
      </h1>

      <time class="post-time">
          Dec 18 2012
      </time>
    </header>



    
            <div class="post-content">
            <p>开启mod_rewrite<br>开启mod_rewrite模块<br>使用URL重写功能，需要安装mod_rewrite模块。使用phpinfo()函数，找到Apache Modules section部分，可以看到当前apache加载模块。<br>如果没有开启mod_rewrite, 就需要配置mod_rewrite.so的路径：<br>LoadModule rewrite_module modules/mod_rewrite.so<br>Apache2内置了mod_rewirte，在配置虚拟主机的配置文件VirtualHost部分打开引擎：RewriteEngine on<br>这句之后就可以使用重写语法了。<br>VirtualHost文件部分的Directory配置必须是：<br>···<br>Options Includes FollowSymLinks #允许使用符号链接<br>AllowOverride All #允许目录配置文件.htaccess。如果不使用是AllowOverride None<br>···<br>利用mod_rewrite重写URL主要使用两个基本的指令RewriteRule和RewriteCond。</p>
<p>RewriteRule指令<br>RewriteRule Pattern Substitution [Flags]<br>在模式（Pattern）和替换（Substitution）中使用正则表达式来匹配相应的字符。<br>譬如有如下的URL：<br><a href="http://www.example.com/display.php?country=USA" target="_blank" rel="noopener">http://www.example.com/display.php?country=USA</a> &amp;state=California&amp;city=San_Diego<br>REQUEST_URI的值是“/country=USA &amp;state=California&amp;city=San_Diego”，要将国家州城市信息更友好的显示给用，要显示成这样：</p>
<p><a href="http://www.example.com/USA/California/San_Diego" target="_blank" rel="noopener">http://www.example.com/USA/California/San_Diego</a></p>
<p>一个最常用的正则就是（.<em>）。它含有两个元素：一是“点”，表示任 意字符；二是“星”，表示以前的全部字符。所以（.*）会匹配{REQUEST_URI}的所有字符。Rewrite重写引擎的输入串是 {REQUEST_URI}，也就是URL中出去域名以及“?”符号后的所有查询字符。<br>重定向的URL中要提取出“USA/California/San_Diego”，匹配模式正则表达式的原型是：<br>(.</em>)/(.<em>)/(.</em>)<br>以上正则，在{REQUEST_URI}中通过两个“/”的分割存储了三个值，为了解决我们具体问题，我们得加一点限制――毕竟，第一个和最后一个原子可以匹配任何字符。<br>开始，我们可以添加一些特殊的字符，比如表示正则“开始”或者“结束”，“^”字符表示正则的开始而“$”表示正则的结束。<br>^(.<em>)/(.</em>)/(.*)$<br>{REQUEST_URI}是以“/”开头。Apache 在更改版本的时候会更改正则引擎，一代Apache要求有斜杠而二代Apache却不允许！但是我们可以用^/?（？表示匹配字符本身或者前一个字符）来 兼容两个版本的Apache。再加上对字符匹配的限制，最终匹配模式是：<br>^/?([a-zA-Z_]+)/([a-zA-Z_]+)/([a-zA-Z_]+)$<br>完整表示如下：<br>RewriteEngine on<br>RewriteRule ^/?([a-zA-Z_]+)/([a-zA-Z_]+)/([a-zA-Z_]+)$ display.php?country=$1 &amp;state=$2&amp;city=$3 [L]<br>RewriteRule使用$1到$9引用模式()中匹配的内容，称为反向引用。对于URL：</p>
<p><a href="http://www.example.com/USA/California/San_Diego" target="_blank" rel="noopener">http://www.example.com/USA/California/San_Diego</a></p>
<p>$1=USA，$2=California，$3=San_Diego</p>
<p>RewriteRule选项<br>“redirect|R[=code]” 强制重定向。经常引用到触发可见的定向。默认情况下它是一个HTTP 302的临时重定向，但是你可以注明具体的HTTP 代码，比如你可以用[R=301]来表明这是一个永久重定向，这对搜索引擎抓取你重定向后的网页相当有用。<br>“proxy|P” 强制为代理<br>“forbidden|F” 403 禁止。告诉Apache响应请求时不提供页面。其原理就是Apache会发出一个403 HTTP相应，可以保护网站不被未经授权的或者其他盗链访问。<br>“nocase|NC” 忽略正则表达式中的大小写。它经常被用到{HTTP_HOST}服务器参数上，因为域名里面是不会区分大小写的。<br>“next|N” 回到第一条规则。可以让你的重写条件循环匹配，当你不知道{REQUEST_URI}有多少字符进行匹配的时候很有用。<br>“last|L” 最后一个规则。告诉Apache服务器一系列的条件或者是规则将在它出现后结束，换句话说就是[L]不出现，mod_rewrite将会一直执行。<br>“noescape|NE” 在输出中不对URI作转义。此标记阻止mod_rewrite对重写结果应用常规的URI转义规则。 一般情况下，特殊字符(如‘%’, ‘$’, ‘;’等)会被转义为等值的十六进制编码。 此标记可以阻止这样的转义，以允许百分号等符号出现在输出中，如：<br>RewriteRule /foo/(.*) /bar?arg=P1%3d$1 [R,NE]<br>可以使‘/foo/zed’转向到一个安全的请求‘/bar?arg=P1=zed’.<br>“skip|S=N” 跳过下面的N条规则。</p>
<p>RewriteCond指令<br>RewriteCond TestString CondPattern [Flags]<br>RewriteCond指令定义了一个规则的条件，即在一个RewriteRule指令之前有一个或多个RewriteCond指令。 条件之后的重写规则仅在当前URI与pattern匹配并且符合这些条件的时候才会起作用。<br>RewriteCond也有反向引用，但和RewriteRule中用$N引用不同，它使用%N反向引用。<br>RewriteCond引用Apache变量%{ NAME_OF_VARIABLE}，如%{HTTP_HOST}。<br>RewriteCond的条件模式（CondPattern）除了使用perl样式正则表达式，还有额外的规则：</p>
<ol>
<li>使用‘!’ 字符(惊叹号)来实现匹配的反转</li>
<li>‘,=。</li>
<li>‘-d’ (是一个目录[directory])。将TestString视为一个路径名并测试它是否存在而且是一个目录.</li>
<li>‘-f’ (是一个常规的文件[file])。将TestString视为一个路径名并测试它是否存在而且是一个常规的文件.</li>
<li>‘-s’ (是一个非空的常规文件[size])。将TestString视为一个路径名并测试它是否存在而且是一个尺寸大于0的常规的文件.</li>
<li>‘-l’ (是一个符号连接[link])。将TestString视为一个路径名并测试它是否存在而且是一个符号连接.</li>
<li>‘-F’ (对子请求有效的业已存在的文件)。测试TestString是否一个有效的文件， 而且可以被服务器当前已经配置的所有存取控制所存取。 它用一个内部子请求来做判断，由于会降低服务器的性能，请小心使用!</li>
</ol>
<p>RewriteCond选项<br>‘nocase|NC’ (no case)。它使测试忽略大小写。此标记仅作用于TestString和CondPattern的比较， 而对文件系统和子请求的测试不起作用。<br>‘ornext|OR’ (or next condition)。它以OR方式组合若干规则的条件，而不是默认的AND。典型的例子如下：<br>RewriteCond %{REMOTE_HOST} ^host1.* [OR]<br>RewriteCond %{REMOTE_HOST} ^host2.* [OR]<br>RewriteCond %{REMOTE_HOST} ^host3.*<br>RewriteRule …some special stuff for any of these hosts…<br>如果不用这个标记，则必须使用三个 条件/规则。</p>
<p>服务器变量<br>HTTP变量<br>HTTP_USER_AGENT, HTTP_REFERER, HTTP_COOKIE,<br>HTTP_FORWARDED, HTTP_HOST, HTTP_PROXY_CONNECTION, HTTP_ACCEPT<br>连结和请求的变量<br>REMOTE_ADDR, REMOTE_HOST, REMOTE_USER, REMOTE_IDENT,<br>REQUEST_METHOD, SCRIPT_FILENAME, PATH_INFO, QUERY_STRING, AUTH_TYPE<br>服务器内部变量<br>DOCUMENT_ROOT, SERVER_ADMIN, SERVER_NAME, SERVER_ADDR,<br>SERVER_PORT, SERVER_PROTOCOL, SERVER_SOFTWARE<br>系统变量<br>TIME_YEAR, TIME_MON, TIME_DAY, TIME_HOUR,<br>TIME_MIN, TIME_SEC, TIME_WDAY, TIME<br>mod_rewrite特殊值<br>API_VERSION, THE_REQUEST, REQUEST_URI, REQUEST_FILENAME</p>
<p>URL重写举例</p>
<ol>
<li><p>给子域名加www标记<br>RewriteCond %{HTTP_HOST} ^([a-z.]+)?example.com$ [NC]<br>RewriteCond %{HTTP_HOST} !^www. [NC]<br>RewriteRule .? <a href="http://www.%1example.com%{REQUEST_URI}" target="_blank" rel="noopener">http://www.%1example.com%{REQUEST_URI}</a> [R=301,L]<br>这个规则抓取二级域名的%1变量，如果不是以www开始，那么就加www，以前的域名以及{REQUEST_URI}会跟在其后。</p>
</li>
<li><p>去掉域名中的www标记<br>RewriteCond %{HTTP_HOST} !^example.com$ [NC]<br>RewriteRule .? <a href="http://example.com%{REQUEST_URI}" target="_blank" rel="noopener">http://example.com%{REQUEST_URI}</a> [R=301,L]</p>
</li>
<li><p>去掉www标记，但是保存子域名<br>RewriteCond %{HTTP_HOST} ^www.(([a-z0-9_]+.)?example.com)$ [NC]<br>RewriteRule .? http://%1%{REQUEST_URI} [R=301,L]<br>这里，当匹配到1%变量以后，子域名才会在%2（内部原子）中抓取到，而我们需要的正是这个%1变量。</p>
</li>
<li><p>防止图片盗链<br>一些站长不择手段的将你的图片盗链在他们网站上，耗费你的带宽。你可以加一下代码阻止这种行为。<br>RewriteCond %{HTTP_REFERER} !^$<br>RewriteCond %{HTTP_REFERER} !^http://(www.)?example.com/ [NC]<br>RewriteRule .(gif|jpg|png)$ – [F]<br>如果{HTTP_REFERER}值不为空，或者不是来自你自己的域名，这个规则用[F]FLAG阻止以gif|jpg|png 结尾的URL<br>如果对这种盗链你是坚决鄙视的，你还可以改变图片，让访问盗链网站的用户知道该网站正在盗用你的图片。<br>RewriteCond %{HTTP_REFERER} !^$<br>RewriteCond %{HTTP_REFERER} !^http://(www.)?example.com/.*$ [NC]<br>RewriteRule .(gif|jpg|png)$ <a href="http://www.example.com/hotlinked.gif" target="_blank" rel="noopener">http://www.example.com/hotlinked.gif</a> [R=301,L]<br>除了阻止图片盗链链接，以上规则将其盗链的图片全部替换成了你设置的图片。<br>你还可以阻止特定域名盗链你的图片：<br>RewriteCond %{HTTP_REFERER} !^http://(www.)?leech_site.com/ [NC]<br>RewriteRule .(gif|jpg|png)$ – [F,L]<br>这个规则将阻止域名黑名单上所有的图片链接请求。<br>当然以上这些规则都是以{HTTP_REFERER}获取域名为基础的，如果你想改用成IP地址，用{REMOTE_ADDR}就可以了。</p>
</li>
<li><p>如果文件不存在重定向到404页面<br>RewriteCond %{DOCUMENT_ROOT}%{REQUEST_FILENAME} !-f<br>RewriteCond %{DOCUMENT_ROOT}%{REQUEST_FILENAME} !-d<br>RewriteRule .? /404.php [L]</p>
</li>
</ol>
<p>-f匹配的是存在的文件名，-d匹配的存在的路径名</p>
<ol start="6">
<li><p>创建无文件后缀名链接<br>RewriteCond %{REQUEST_FILENAME}.php -f<br>RewriteRule ^/?([a-zA-Z0-9]+)$ $1.php [L]<br>RewriteCond %{REQUEST_FILENAME}.html -f<br>RewriteRule ^/?([a-zA-Z0-9]+)$ $1.html [L]<br>如果文件是以.php为后缀，这条规则将被执行。</p>
</li>
<li><p>强制使用HTTPS<br>RewriteCond %{HTTPS} !on<br>#RewriteCond %{SERVER_PORT} !^443$<br>RewriteCond %{HTTP_HOST} ^([a-z.]+)?example.com$ [NC]<br>RewriteRule ^(.<em>)$ https://%1example.com$1 [R=301,L]<br>判断HTTPS服务可以判断安全端口（一般是443），也可以通过HTTPS变量。将example.com域名下所有url都强制使用https服务。<br>如果不判断域名，可以这样：<br>RewriteCond %{HTTPS} !on<br>RewriteRule ^/?(.</em>)$ https://%{SERVER_NAME}/$1 [R=301,L]<br>这里的$1前面有斜杠/，其实是匹配模式去掉了斜杠的原因，和上面效果是一样的。</p>
</li>
</ol>
<p>推荐资源</p>
<blockquote>
<p>正则表达式工具firefox扩展：Regular Expressions Tester<br>正则表Introduction to the Tutorial：<br><a href="http://gnosis.cx/publish/programming/regular_expressions.html" target="_blank" rel="noopener">http://gnosis.cx/publish/programming/regular_expressions.html</a><br>Apache文档之mod_rewrite介绍：<br><a href="http://www.uplinux.com/download/doc/apache/ApacheManual/mod/mod_rewrite.html" target="_blank" rel="noopener">http://www.uplinux.com/download/doc/apache/ApacheManual/mod/mod_rewrite.html</a><br>Apache文档之URL重写指南：<br><a href="http://www.uplinux.com/download/doc/apache/ApacheManual/misc/rewriteguide.html" target="_blank" rel="noopener">http://www.uplinux.com/download/doc/apache/ApacheManual/misc/rewriteguide.html</a><br>Learn Apache mod_rewrite: 13 Real-world Examples，原文：<br><a href="http://www.sitepoint.com/article/apache-mod_rewrite-examples/" target="_blank" rel="noopener">http://www.sitepoint.com/article/apache-mod_rewrite-examples/</a><br>Learn Apache mod_rewrite: 13 Real-world Examples，译文：<a href="http://www.tsingfeng.com/?p=357" target="_blank" rel="noopener">http://www.tsingfeng.com/?p=357</a><br>A Beginner’s Guide to URL Rewriting：<br><a href="http://www.sitepoint.com/article/guide-url-rewriting/" target="_blank" rel="noopener">http://www.sitepoint.com/article/guide-url-rewriting/</a><br>Apache的Mod_rewrite 例子：<br><a href="http://dreamwaver.bokee.com/5692845.html" target="_blank" rel="noopener">http://dreamwaver.bokee.com/5692845.html</a></p>
</blockquote>

            </div>
          

    
      <footer class="post-footer">
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/public/2012/12/18/php URL重写/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">php URL重写</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/public/2012/12/18/apache .htaccess 规则/">
        <span class="next-text nav-default">apache .htaccess 规则</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2019
    <span class="footer-author">ningmo.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/public/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/public/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/public/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
